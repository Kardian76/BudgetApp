<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Purrfect Budget</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS install friendliness -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="Icon_192.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#b91c1c;
      --accent:#0f172a;
      --shadow: 0 2px 18px rgba(15,23,42,.08);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      background:rgba(246,247,251,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:960px;margin:0 auto;padding:14px 14px 86px}
    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    h1{font-size:18px;margin:0}
    .meta{
      font-size:12px;color:var(--muted);line-height:1.3;margin-top:4px
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border); background:#fff;
      padding:6px 10px; border-radius:999px;
    }

    .grid{display:grid; gap:12px; margin-top:12px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      font-size:14px;margin:0 0 10px 0;color:var(--text);
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
    }
    .small{font-size:12px;color:var(--muted)}
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, button, textarea{
      font:inherit;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    button{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
    }
    button.primary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    button.danger{
      background:var(--danger);
      color:#fff;
      border-color:var(--danger);
    }
    button:disabled{
      opacity:.55; cursor:not-allowed;
    }

    .table{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr;
      gap:8px;
      align-items:center;
    }
    .th{font-size:12px;color:var(--muted)}
    .cell{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .nameCell{font-weight:600}
    .neg{color:var(--danger); font-variant-numeric: tabular-nums;}
    .num{font-variant-numeric: tabular-nums;}
    .divider{height:1px;background:var(--border);margin:12px 0}

    /* Bottom buttons */
    .dock{
      position:fixed; left:0; right:0; bottom:0; z-index:6;
      pointer-events:none;
    }
    .dockInner{
      max-width:960px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      pointer-events:none;
    }
    .dockInner button{
      pointer-events:auto;
      box-shadow:var(--shadow);
      background:#fff;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; z-index:50;
      background:rgba(15,23,42,.35);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(960px, 100%);
      max-height:86vh;
      overflow:auto;
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:6px;
    }
    .modalTop h3{margin:0;font-size:14px}
    .modalOverlay.show{display:flex}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .error{
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      padding:10px;
      border-radius:10px;
      font-size:12px;
      margin-top:10px;
      white-space:pre-wrap;
    }
    .success{
      background:#ecfeff;
      border:1px solid #a5f3fc;
      color:#155e75;
      padding:10px;
      border-radius:10px;
      font-size:12px;
      margin-top:10px;
      white-space:pre-wrap;
    }

    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .table{grid-template-columns: 1.2fr 1fr 1fr}
      .miniGrid{grid-template-columns: 1fr}
      .row > *{flex:unset;width:100%}
    }
    .chipRow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      color:var(--muted);
    }
    .mutedLink{
      color:var(--muted);
      text-decoration:underline;
      cursor:pointer;
      font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="padding-bottom:12px">
      <div class="titleRow">
        <div>
          <h1>Purrfect Budget</h1>
          <div class="meta" id="periodMeta">Loading…</div>
        </div>
        <div class="pill" id="connPill">Not connected</div>
      </div>
      <div class="chipRow" id="statusChips"></div>
    </div>
  </header>

  <main class="wrap">
    <!-- INIT FLOW -->
    <div class="card" id="initCard" style="display:none">
      <h2>
        <span>First-time setup</span>
        <span class="small">Server authoritative</span>
      </h2>
      <div class="hint">
        Define the budget period and up to 10 categories. This writes to the server. Clients only display values and submit changes.
      </div>

      <div class="divider"></div>

      <div class="miniGrid">
        <div>
          <label>Budget period type</label>
          <select id="initPeriodType">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="semi_monthly">Semi-monthly (1–14, 15–end)</option>
            <option value="monthly" selected>Monthly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
        <div>
          <label>Period anchor date (YYYY-MM-DD)</label>
          <input id="initAnchorDate" placeholder="2026-01-01" />
        </div>
      </div>

      <div class="divider"></div>

      <h2 style="margin-top:0">
        <span>Categories (1–10)</span>
        <span class="small">Budget dollars</span>
      </h2>

      <div id="initCats"></div>

      <div class="row" style="margin-top:10px">
        <button id="btnAddCat" type="button">Add category</button>
        <button class="primary" id="btnInit" type="button">Initialize</button>
      </div>

      <div id="initMsg"></div>
    </div>

    <!-- MAIN UI -->
    <div class="grid" id="mainUi" style="display:none">
      <div class="card">
        <h2>
          <span>Current period</span>
          <span class="small" id="curPeriodKey"></span>
        </h2>
        <div class="table">
          <div class="th">Category</div>
          <div class="th">Remaining</div>
          <div class="th">Spent</div>
        </div>
        <div style="height:8px"></div>
        <div id="summaryRows" class="table" style="grid-template-columns: 1.4fr 1fr 1fr"></div>
      </div>

      <div class="card">
        <h2>
          <span>Enter deductions / refunds</span>
          <span class="small">Posts to server</span>
        </h2>

        <div class="hint">
          Enter amounts to deduct per category. Check “Refund” to add back (server applies negative spent). Budgets may go negative.
        </div>

        <div class="divider"></div>

        <div id="txnRows"></div>

        <div class="row" style="margin-top:12px">
          <button id="btnClearTxn" type="button">Clear</button>
          <button class="primary" id="btnSubmitTxn" type="button">Submit</button>
        </div>

        <div id="txnMsg"></div>
      </div>
    </div>
  </main>

  <!-- Bottom dock buttons -->
  <div class="dock">
    <div class="dockInner">
      <button id="btnPrior" type="button">Prior period</button>
      <button id="btnSettings" type="button">Settings</button>
    </div>
  </div>

  <!-- Prior period modal -->
  <div class="modalOverlay" id="priorModal">
    <div class="modal">
      <div class="modalTop">
        <h3>Prior period summary</h3>
        <button type="button" data-close="priorModal">Close</button>
      </div>
      <div class="hint" id="priorMeta">—</div>
      <div class="divider"></div>
      <div class="table">
        <div class="th">Category</div>
        <div class="th">Spent</div>
        <div class="th">Rolled over</div>
      </div>
      <div style="height:8px"></div>
      <div id="priorRows" class="table" style="grid-template-columns: 1.4fr 1fr 1fr"></div>
      <div id="priorMsg" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modalOverlay" id="settingsModal">
    <div class="modal">
      <div class="modalTop">
        <h3>Settings</h3>
        <button type="button" data-close="settingsModal">Close</button>
      </div>

      <div class="card" style="box-shadow:none; margin:10px 0; border-radius:12px">
        <h2>
          <span>Connection</span>
          <span class="small">Stored locally</span>
        </h2>

        <div class="miniGrid">
          <div>
            <label>API base URL</label>
            <input id="cfgBaseUrl" placeholder="https://purrfect-budget-api.kardian.workers.dev" />
          </div>
          <div>
            <label>Bearer token</label>
            <input id="cfgToken" placeholder="Your token" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnSaveCfg" type="button">Save</button>
          <button id="btnTestCfg" type="button">Test</button>
        </div>
        <div class="hint" style="margin-top:6px">
          Security note: the token controls access. Treat it like a password.
        </div>
        <div id="cfgMsg"></div>
      </div>

      <div class="card" style="box-shadow:none; margin:10px 0; border-radius:12px">
        <h2>
          <span>Adjust budgets (next period)</span>
          <span class="small">Takes effect next period</span>
        </h2>
        <div class="hint">
          Saves next-period amounts only. Current period is never altered.
        </div>
        <div class="divider"></div>
        <div id="nextBudgetRows"></div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="btnSaveNextBudgets" type="button">Save next-period budgets</button>
        </div>
        <div id="nextBudgetMsg"></div>
      </div>

      <div class="card" style="box-shadow:none; margin:10px 0; border-radius:12px">
        <h2>
          <span>Categories (current period)</span>
          <span class="small">Affects current period</span>
        </h2>

        <div class="miniGrid">
          <div>
            <label>Add category name</label>
            <input id="catAddName" placeholder="Dining" />
          </div>
          <div>
            <label>Budget dollars</label>
            <input id="catAddBudget" placeholder="120.00" />
          </div>
        </div>
        <div class="miniGrid" style="margin-top:10px">
          <div>
            <label>Sort order (optional)</label>
            <input id="catAddSort" placeholder="99" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px">
            <button class="primary" id="btnAddCategory" type="button" style="width:100%">Add category</button>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Remove category</label>
          <select id="catRemoveSelect"></select>
          <div class="row" style="margin-top:10px">
            <button class="danger" id="btnRemoveCategory" type="button">Remove selected</button>
          </div>
        </div>

        <div id="catMsg"></div>
      </div>

      <div class="card" style="box-shadow:none; margin:10px 0; border-radius:12px; border-color:#fecdd3">
        <h2>
          <span style="color:var(--danger)">Reset everything</span>
          <span class="small">Destructive</span>
        </h2>
        <div class="hint">
          Deletes all categories, budgets, periods, and history, and clears initialization.
        </div>
        <div class="row" style="margin-top:10px">
          <button class="danger" id="btnReset" type="button">Reset</button>
          <span class="mutedLink" id="resetHint">Requires confirm</span>
        </div>
        <div id="resetMsg"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------------------
    // Storage / config
    // ---------------------------------------------------------------------
    const LS_BASE = "purrfectbudget.baseUrl";
    const LS_TOKEN = "purrfectbudget.token";

    function getConfig() {
      const baseUrl = (localStorage.getItem(LS_BASE) || "").trim().replace(/\/+$/,"");
      const token = (localStorage.getItem(LS_TOKEN) || "").trim();
      return { baseUrl, token };
    }
    function setConfig(baseUrl, token) {
      localStorage.setItem(LS_BASE, (baseUrl || "").trim().replace(/\/+$/,""));
      localStorage.setItem(LS_TOKEN, (token || "").trim());
    }

    // ---------------------------------------------------------------------
    // DOM helpers
    // ---------------------------------------------------------------------
    const $ = (id) => document.getElementById(id);

    function showModal(id) { $(id).classList.add("show"); }
    function hideModal(id) { $(id).classList.remove("show"); }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-close]");
      if (btn) hideModal(btn.getAttribute("data-close"));
      // Click outside modal closes
      if (e.target.classList.contains("modalOverlay")) e.target.classList.remove("show");
    });

    // ---------------------------------------------------------------------
    // Formatting
    // ---------------------------------------------------------------------
    function centsToDollars(cents) {
      const n = Number(cents || 0);
      const sign = n < 0 ? "-" : "";
      const abs = Math.abs(n);
      const dollars = (abs / 100).toFixed(2);
      return sign + "$" + dollars;
    }

    function isoToMmDdYyyy(iso) {
      // API returns ISO with offset; we only display date portion.
      if (!iso || typeof iso !== "string" || iso.length < 10) return "";
      const d = iso.slice(0,10); // YYYY-MM-DD
      const [y,m,dd] = d.split("-");
      return `${m}-${dd}-${y}`;
    }

    // ---------------------------------------------------------------------
    // API
    // ---------------------------------------------------------------------
    async function api(path, options = {}) {
      const { baseUrl, token } = getConfig();
      if (!baseUrl || !token) throw new Error("Missing API base URL or token. Open Settings and set Connection.");

      const url = baseUrl.replace(/\/+$/,"") + path;
      const headers = new Headers(options.headers || {});
      headers.set("Authorization", `Bearer ${token}`);

      const init = {
        method: options.method || "GET",
        headers,
        body: options.body,
      };

      if (options.json !== undefined) {
        headers.set("Content-Type", "application/json");
        init.body = JSON.stringify(options.json);
      }

      const res = await fetch(url, init);
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

      if (!res.ok) {
        const msg = (data && (data.detail || data.error)) ? `${data.error || "Error"}: ${data.detail || ""}` : `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    // ---------------------------------------------------------------------
    // State
    // ---------------------------------------------------------------------
    let state = null;

    async function refreshState() {
      state = await api("/api/budget/state");
      renderAll();
    }

    function renderAll() {
      renderConnection();
      if (!state || state.initialized === false) {
        $("mainUi").style.display = "none";
        $("initCard").style.display = "block";
        renderInitRows();
        $("periodMeta").textContent = "Not initialized";
        $("curPeriodKey").textContent = "";
        $("btnPrior").disabled = true;
        return;
      }

      $("initCard").style.display = "none";
      $("mainUi").style.display = "grid";
      $("btnPrior").disabled = !state.prior_period;

      const p = state.period;
      $("curPeriodKey").textContent = p.period_key;
      $("periodMeta").textContent =
        `Period: ${isoToMmDdYyyy(p.start_ts)} to ${isoToMmDdYyyy(p.end_ts)} (ET)`;

      renderSummary();
      renderTxnInputs();
      renderPrior();
      renderSettingsBudgets();
      renderSettingsCategories();
    }

    function renderConnection() {
      const { baseUrl, token } = getConfig();
      const ok = !!(baseUrl && token);
      $("connPill").textContent = ok ? "Connected" : "Not connected";
      $("connPill").style.borderColor = ok ? "#a7f3d0" : "var(--border)";
      $("connPill").style.color = ok ? "#065f46" : "var(--muted)";

      const chips = $("statusChips");
      chips.innerHTML = "";
      if (baseUrl) chips.appendChild(chip(`API: ${baseUrl}`));
      if (token) chips.appendChild(chip(`Token: ${"*".repeat(Math.min(8, token.length))}`));
      if (!baseUrl || !token) chips.appendChild(chip("Open Settings → Connection"));
    }

    function chip(text) {
      const d = document.createElement("div");
      d.className = "chip";
      d.textContent = text;
      return d;
    }

    // ---------------------------------------------------------------------
    // Summary UI
    // ---------------------------------------------------------------------
    function renderSummary() {
      const wrap = $("summaryRows");
      wrap.innerHTML = "";
      const cats = state.categories || [];
      for (const c of cats) {
        wrap.appendChild(cell(c.name, "cell nameCell"));
        wrap.appendChild(cellMoney(c.remaining_cents));
        wrap.appendChild(cellMoney(c.spent_cents));
      }
    }

    function cell(text, cls="cell") {
      const d = document.createElement("div");
      d.className = cls;
      d.textContent = text;
      return d;
    }

    function cellMoney(cents) {
      const d = document.createElement("div");
      const n = Number(cents || 0);
      d.className = "cell num" + (n < 0 ? " neg" : "");
      d.textContent = centsToDollars(n);
      return d;
    }

    // ---------------------------------------------------------------------
    // Transaction inputs
    // ---------------------------------------------------------------------
    function renderTxnInputs() {
      const wrap = $("txnRows");
      wrap.innerHTML = "";

      const cats = state.categories || [];
      for (const c of cats) {
        const row = document.createElement("div");
        row.className = "card";
        row.style.boxShadow = "none";
        row.style.borderRadius = "12px";
        row.style.margin = "0 0 10px 0";

        row.innerHTML = `
          <div class="row">
            <div style="flex:2">
              <div style="font-weight:700">${escapeHtml(c.name)}</div>
              <div class="small">Remaining: <span class="${Number(c.remaining_cents)<0?'neg':''}">${escapeHtml(centsToDollars(c.remaining_cents))}</span>
                · Spent: ${escapeHtml(centsToDollars(c.spent_cents))}
              </div>
            </div>
            <div style="flex:1">
              <label>Amount</label>
              <input inputmode="decimal" placeholder="0.00" data-txn-amt="${c.category_id}" />
            </div>
            <div style="flex:1">
              <label style="display:flex;align-items:center;gap:10px">
                <input type="checkbox" data-txn-ref="${c.category_id}" style="width:18px;height:18px;margin:0" />
                Refund
              </label>
              <div class="small">Checks subtract from spent</div>
            </div>
          </div>
        `;
        wrap.appendChild(row);
      }
    }

    function clearTxnInputs() {
      document.querySelectorAll("[data-txn-amt]").forEach(i => i.value = "");
      document.querySelectorAll("[data-txn-ref]").forEach(i => i.checked = false);
      $("txnMsg").innerHTML = "";
    }

    async function submitTransactions() {
      $("txnMsg").innerHTML = "";
      const items = [];
      const cats = state.categories || [];

      for (const c of cats) {
        const amtEl = document.querySelector(`[data-txn-amt="${c.category_id}"]`);
        const refEl = document.querySelector(`[data-txn-ref="${c.category_id}"]`);
        if (!amtEl) continue;

        const raw = (amtEl.value || "").trim();
        if (!raw) continue;

        // Client does not do budget math; it only parses dollars to send.
        if (!/^\d+(\.\d{1,2})?$/.test(raw)) {
          throw new Error(`Invalid amount for ${c.name}: "${raw}" (use 0.00 format)`);
        }

        items.push({
          category_id: c.category_id,
          amount_dollars: raw,
          is_refund: !!(refEl && refEl.checked)
        });
      }

      if (items.length === 0) {
        $("txnMsg").innerHTML = `<div class="error">Enter at least one amount.</div>`;
        return;
      }

      $("btnSubmitTxn").disabled = true;
      try {
        const data = await api("/api/budget/transactions", { method:"POST", json:{ items } });
        state = data;
        $("txnMsg").innerHTML = `<div class="success">Saved.</div>`;
        renderAll();
        // keep inputs for reference; user can clear manually
      } catch (e) {
        $("txnMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnSubmitTxn").disabled = false;
      }
    }

    // ---------------------------------------------------------------------
    // Prior period modal
    // ---------------------------------------------------------------------
    function renderPrior() {
      const prior = state.prior_period;
      if (!prior) {
        $("priorMeta").textContent = "No prior period available yet.";
        $("priorRows").innerHTML = "";
        return;
      }
      $("priorMeta").textContent = `Period: ${isoToMmDdYyyy(prior.start_ts)} to ${isoToMmDdYyyy(prior.end_ts)} (ET)`;

      const wrap = $("priorRows");
      wrap.innerHTML = "";
      for (const c of prior.categories || []) {
        wrap.appendChild(cell(c.name, "cell nameCell"));
        wrap.appendChild(cellMoney(c.spent_cents));
        wrap.appendChild(cellMoney(c.rollover_cents));
      }
    }

    // ---------------------------------------------------------------------
    // Settings: next budgets
    // ---------------------------------------------------------------------
    function renderSettingsBudgets() {
      const wrap = $("nextBudgetRows");
      wrap.innerHTML = "";

      const cats = (state.categories || []).map(c => ({ category_id: c.category_id, name: c.name }));
      for (const c of cats) {
        const row = document.createElement("div");
        row.className = "row";
        row.style.marginBottom = "10px";
        row.innerHTML = `
          <div style="flex:2">
            <label>${escapeHtml(c.name)}</label>
            <input inputmode="decimal" placeholder="e.g., 500.00" data-nextbudget="${c.category_id}" />
          </div>
        `;
        wrap.appendChild(row);
      }

      $("nextBudgetMsg").innerHTML = "";
    }

    async function saveNextBudgets() {
      $("nextBudgetMsg").innerHTML = "";
      const cats = state.categories || [];
      const budgets = [];

      for (const c of cats) {
        const el = document.querySelector(`[data-nextbudget="${c.category_id}"]`);
        if (!el) continue;
        const raw = (el.value || "").trim();
        if (!raw) continue;

        if (!/^-?\d+(\.\d{1,2})?$/.test(raw)) {
          $("nextBudgetMsg").innerHTML = `<div class="error">Invalid amount for ${escapeHtml(c.name)}: "${escapeHtml(raw)}"</div>`;
          return;
        }
        budgets.push({ category_id: c.category_id, budget_dollars: raw });
      }

      if (budgets.length === 0) {
        $("nextBudgetMsg").innerHTML = `<div class="error">Enter at least one next-period amount.</div>`;
        return;
      }

      $("btnSaveNextBudgets").disabled = true;
      try {
        const data = await api("/api/budget/adjust-next", { method:"POST", json:{ budgets } });
        state = data;
        $("nextBudgetMsg").innerHTML = `<div class="success">Saved for next period.</div>`;
        renderAll();
      } catch (e) {
        $("nextBudgetMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnSaveNextBudgets").disabled = false;
      }
    }

    // ---------------------------------------------------------------------
    // Settings: categories add/remove
    // ---------------------------------------------------------------------
    function renderSettingsCategories() {
      const sel = $("catRemoveSelect");
      sel.innerHTML = "";
      for (const c of state.categories || []) {
        const opt = document.createElement("option");
        opt.value = String(c.category_id);
        opt.textContent = c.name;
        sel.appendChild(opt);
      }
      $("catMsg").innerHTML = "";
    }

    async function addCategory() {
      $("catMsg").innerHTML = "";
      const name = ($("catAddName").value || "").trim();
      const budget = ($("catAddBudget").value || "").trim();
      const sort = ($("catAddSort").value || "").trim();

      if (!name) {
        $("catMsg").innerHTML = `<div class="error">Enter a category name.</div>`;
        return;
      }
      if (budget && !/^-?\d+(\.\d{1,2})?$/.test(budget)) {
        $("catMsg").innerHTML = `<div class="error">Invalid budget dollars.</div>`;
        return;
      }
      if (sort && !/^\d+$/.test(sort)) {
        $("catMsg").innerHTML = `<div class="error">Sort order must be an integer.</div>`;
        return;
      }

      const add = [{ name, budget_dollars: budget || "0.00" }];
      if (sort) add[0].sort_order = Number(sort);

      $("btnAddCategory").disabled = true;
      try {
        const data = await api("/api/budget/categories", { method:"POST", json:{ add } });
        state = data;
        $("catMsg").innerHTML = `<div class="success">Category added.</div>`;
        $("catAddName").value = "";
        $("catAddBudget").value = "";
        $("catAddSort").value = "";
        renderAll();
      } catch (e) {
        $("catMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnAddCategory").disabled = false;
      }
    }

    async function removeCategory() {
      $("catMsg").innerHTML = "";
      const id = Number(($("catRemoveSelect").value || "").trim());
      if (!Number.isInteger(id) || id <= 0) {
        $("catMsg").innerHTML = `<div class="error">Select a category to remove.</div>`;
        return;
      }

      $("btnRemoveCategory").disabled = true;
      try {
        const data = await api("/api/budget/categories", { method:"POST", json:{ remove: [{ category_id: id }] } });
        state = data;
        $("catMsg").innerHTML = `<div class="success">Category removed.</div>`;
        renderAll();
      } catch (e) {
        $("catMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnRemoveCategory").disabled = false;
      }
    }

    // ---------------------------------------------------------------------
    // Reset
    // ---------------------------------------------------------------------
    async function resetAll() {
      $("resetMsg").innerHTML = "";
      const ok = window.confirm("This will delete ALL categories, periods, and history. Type RESET in the next prompt to confirm.");
      if (!ok) return;
      const confirmStr = window.prompt('Type RESET to confirm:', '');
      if (confirmStr !== "RESET") {
        $("resetMsg").innerHTML = `<div class="error">Reset canceled.</div>`;
        return;
      }

      $("btnReset").disabled = true;
      try {
        await api("/api/budget/reset", { method:"POST", json:{ confirm:"RESET" } });
        $("resetMsg").innerHTML = `<div class="success">Reset complete. Reloading state…</div>`;
        state = null;
        await safeInitialLoad();
        hideModal("settingsModal");
      } catch (e) {
        $("resetMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnReset").disabled = false;
      }
    }

    // ---------------------------------------------------------------------
    // Init flow UI helpers
    // ---------------------------------------------------------------------
    function renderInitRows() {
      const wrap = $("initCats");
      if (wrap.childElementCount === 0) {
        // Default 2 rows
        addInitRow();
        addInitRow();
      }
      // no-op otherwise (preserve user input)
    }

    function addInitRow() {
      const wrap = $("initCats");
      const idx = wrap.childElementCount + 1;
      if (idx > 10) return;

      const row = document.createElement("div");
      row.className = "miniGrid";
      row.style.marginBottom = "10px";
      row.innerHTML = `
        <div>
          <label>Category name</label>
          <input placeholder="Groceries" data-init-name="${idx}" />
        </div>
        <div>
          <label>Budget dollars</label>
          <input inputmode="decimal" placeholder="500.00" data-init-budget="${idx}" />
        </div>
      `;
      wrap.appendChild(row);
      $("btnAddCat").disabled = wrap.childElementCount >= 10;
    }

    async function submitInit() {
      $("initMsg").innerHTML = "";

      const period_type = $("initPeriodType").value;
      const period_anchor_date = ($("initAnchorDate").value || "").trim();

      if (!/^\d{4}-\d{2}-\d{2}$/.test(period_anchor_date)) {
        $("initMsg").innerHTML = `<div class="error">Anchor date must be YYYY-MM-DD.</div>`;
        return;
      }

      const rows = $("initCats").querySelectorAll("[data-init-name]");
      const categories = [];
      const seen = new Set();

      rows.forEach((nameEl) => {
        const i = nameEl.getAttribute("data-init-name");
        const budgetEl = document.querySelector(`[data-init-budget="${i}"]`);
        const name = (nameEl.value || "").trim();
        const budget = (budgetEl?.value || "").trim();

        if (!name && !budget) return; // allow empty trailing rows
        if (!name) throw new Error("Each category row needs a name.");
        if (!budget) throw new Error(`Category "${name}" needs a budget.`);

        if (!/^-?\d+(\.\d{1,2})?$/.test(budget)) throw new Error(`Invalid budget for "${name}".`);

        const key = name.toLowerCase();
        if (seen.has(key)) throw new Error(`Duplicate category name: "${name}".`);
        seen.add(key);

        categories.push({ name, budget_dollars: budget, sort_order: categories.length + 1 });
      });

      if (categories.length < 1 || categories.length > 10) {
        $("initMsg").innerHTML = `<div class="error">Provide 1–10 categories.</div>`;
        return;
      }

      $("btnInit").disabled = true;
      try {
        const data = await api("/api/budget/init", {
          method: "POST",
          json: { period_type, period_anchor_date, categories }
        });
        state = data;
        $("initMsg").innerHTML = `<div class="success">Initialized.</div>`;
        renderAll();
      } catch (e) {
        $("initMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        $("btnInit").disabled = false;
      }
    }

    // ---------------------------------------------------------------------
    // Settings: connection save/test
    // ---------------------------------------------------------------------
    function hydrateSettingsConnection() {
      const { baseUrl, token } = getConfig();
      $("cfgBaseUrl").value = baseUrl || "";
      $("cfgToken").value = token || "";
    }

    async function saveConfig() {
      $("cfgMsg").innerHTML = "";
      const baseUrl = ($("cfgBaseUrl").value || "").trim().replace(/\/+$/,"");
      const token = ($("cfgToken").value || "").trim();

      if (!baseUrl || !/^https?:\/\//.test(baseUrl)) {
        $("cfgMsg").innerHTML = `<div class="error">Enter a valid base URL (https://...).</div>`;
        return;
      }
      if (!token) {
        $("cfgMsg").innerHTML = `<div class="error">Enter the Bearer token.</div>`;
        return;
      }

      setConfig(baseUrl, token);
      renderConnection();

      $("cfgMsg").innerHTML = `<div class="success">Saved.</div>`;
    }

    async function testConfig() {
      $("cfgMsg").innerHTML = "";
      await saveConfig();
      try {
        const s = await api("/api/budget/state");
        $("cfgMsg").innerHTML = `<div class="success">Connected. initialized=${String(s.initialized)}</div>`;
        state = s;
        renderAll();
      } catch (e) {
        $("cfgMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      }
    }

    // ---------------------------------------------------------------------
    // Boot
    // ---------------------------------------------------------------------
    async function safeInitialLoad() {
      try {
        const { baseUrl, token } = getConfig();
        if (!baseUrl || !token) {
          // Prompt user to set connection first
          state = { initialized: false };
          renderAll();
          return;
        }
        await refreshState();
      } catch (e) {
        // If connection fails, show settings guidance
        state = { initialized: false };
        renderAll();
        $("periodMeta").textContent = "Connection failed. Open Settings → Connection.";
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // ---------------------------------------------------------------------
    // Event wiring
    // ---------------------------------------------------------------------
    $("btnSettings").addEventListener("click", () => {
      hydrateSettingsConnection();
      showModal("settingsModal");
    });
    $("btnPrior").addEventListener("click", () => showModal("priorModal"));
    $("btnClearTxn").addEventListener("click", clearTxnInputs);
    $("btnSubmitTxn").addEventListener("click", () => submitTransactions().catch(e => {
      $("txnMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
    }));

    $("btnAddCat").addEventListener("click", () => addInitRow());
    $("btnInit").addEventListener("click", () => submitInit().catch(e => {
      $("initMsg").innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
    }));

    $("btnSaveCfg").addEventListener("click", () => saveConfig());
    $("btnTestCfg").addEventListener("click", () => testConfig());

    $("btnSaveNextBudgets").addEventListener("click", () => saveNextBudgets());
    $("btnAddCategory").addEventListener("click", () => addCategory());
    $("btnRemoveCategory").addEventListener("click", () => removeCategory());
    $("btnReset").addEventListener("click", () => resetAll());

    $("resetHint").addEventListener("click", () => {
      $("resetMsg").innerHTML = `<div class="hint">This calls POST /api/budget/reset with {"confirm":"RESET"}.</div>`;
    });

    // PWA service worker: intentionally not used (server authoritative; no offline requirement).
    // If you later want install prompts only, keep SW disabled.

    safeInitialLoad();
  </script>
</body>
</html>
