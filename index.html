<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0b1320" />
<title>Purrfect Budget</title>

<style>
:root{
  --bg0:#070b12; --bg1:#0b1320;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.10);
  --text:#e9eef7; --muted:rgba(233,238,247,.75);
  --primary:#2d6cdf; --danger:#ffb4b4; --ok:#b6ffcf;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 480px at 10% 0%, rgba(45,108,223,.22), transparent 60%),
    radial-gradient(720px 360px at 90% 10%, rgba(182,255,207,.10), transparent 60%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
h1{font-size:18px;margin:0 0 10px}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.045));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
}
.subcard{margin-top:14px}
.hidden{display:none!important}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
label{font-size:13px;color:var(--muted);margin-top:10px;display:block}
input,select{
  width:100%;padding:10px;border-radius:12px;
  background:rgba(0,0,0,.35);color:var(--text);
  border:1px solid var(--border)
}
button{
  border:0;border-radius:12px;padding:10px 14px;
  font-weight:600;color:#fff;cursor:pointer;
  background:linear-gradient(180deg,#2d6cdf,#1f57c8)
}
button.secondary{background:rgba(255,255,255,.12)}
button.danger{background:rgba(255,180,180,.18);color:#ffd7d7}
button:disabled{opacity:.55}
.status{font-size:13px;color:var(--muted);margin-top:8px}
.status.ok{color:var(--ok)} .status.error{color:var(--danger)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid var(--border)}
th{text-align:left;font-size:13px;color:var(--muted)}
td.right{text-align:right}
.tableScroll{max-height:360px;overflow:auto}
.fab{position:fixed;right:18px;bottom:18px;z-index:50}
.modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:flex;align-items:flex-start;justify-content:center;
  padding:18px;z-index:100
}
.modal{max-width:760px;width:100%;max-height:calc(100vh - 36px);
  overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.045));
  border:1px solid var(--border);border-radius:16px;padding:16px}
.modalHeader{display:flex;justify-content:space-between;align-items:center}
.settingsRow{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
<h1>Purrfect Budget</h1>

<!-- AUTH -->
<div id="authView" class="card hidden">
  <label>Your name</label>
  <input id="userNameInput" placeholder="e.g. Alex" />
  <label>Bearer token</label>
  <input id="tokenInput" type="password" />
  <div class="row">
    <button id="saveTokenBtn">Continue</button>
    <button id="toggleTokenBtn" class="secondary">Show</button>
  </div>
  <div id="authStatus" class="status"></div>
</div>

<!-- SETUP WIZARD -->
<div id="noCategoriesView" class="hidden">
  <div id="wizStep1" class="card">
    <h1>Step 1 — Budget period</h1>
    <label>Period type</label>
    <select id="wizPeriodType">
      <option value="biweekly">Every Two Weeks</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <label>Start date (MM-DD-YYYY)</label>
    <input id="wizStartDate" placeholder="MM-DD-YYYY" />
    <button id="wizNext1">Next</button>
    <div id="wizStatus1" class="status"></div>
  </div>

  <div id="wizStep2" class="card hidden">
    <h1>Step 2 — Categories</h1>
    <div id="wizCatList"></div>
    <div class="row">
      <button id="wizAddCat" class="secondary">Add Category</button>
      <button id="wizNext2">Next</button>
    </div>
    <div id="wizStatus2" class="status"></div>
  </div>

  <div id="wizStep3" class="card hidden">
    <h1>Step 3 — Confirm</h1>
    <div id="wizReview"></div>
    <button id="wizSubmit">Initialize Budget</button>
    <div id="wizStatus3" class="status"></div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="hidden">
  <div id="dashboardView" class="hidden">

    <div class="card">
      <h1>Budget Summary</h1>
      <div class="status">Period: <strong id="periodLabel">—</strong></div>
      <div class="tableScroll">
        <table>
          <thead>
            <tr><th>Category</th><th class="right">Spent</th><th class="right">Remaining</th></tr>
          </thead>
          <tbody id="catTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="grid2">
      <div class="card subcard">
        <h1>Add Transaction</h1>
        <label>Type</label>
        <select id="txType"><option value="expense">Expense</option><option value="refund">Refund</option></select>
        <label>Category</label>
        <select id="txCategory"></select>
        <label>Amount</label>
        <input id="txAmount" placeholder="$0.00" />
        <label>Note</label>
        <input id="txNote" />
        <button id="txSubmitBtn">Save</button>
        <div id="txStatus" class="status"></div>
      </div>
    </div>
  </div>
</div>

<button id="openSettingsBtn" class="fab">Settings</button>
<div id="globalStatus" class="status"></div>
</div>
<div id="settingsOverlay" class="modalOverlay hidden">
<div class="modal">
  <div class="modalHeader">
    <h1>Settings</h1>
    <button id="settingsCloseBtn" class="secondary">Close</button>
  </div>

  <div class="card subcard">
    <h1>Budget Categories</h1>
    <div class="row">
      <button id="settingsAddOpenBtn" class="secondary">Add Budget Categories</button>
      <button id="settingsReorderBtn" class="secondary">Reorder Budget Categories</button>
      <button id="settingsApplyRemoveBtn">Apply Removals</button>
    </div>
    <div id="settingsCatList"></div>
    <div id="settingsCatStatus" class="status"></div>

    <div id="settingsAddPanel" class="subcard hidden">
      <label>Name</label>
      <input id="settingsNewCatName" />
      <label>Budget</label>
      <input id="settingsNewCatBudget" placeholder="$0.00" />
      <button id="settingsAddCatBtn">Add</button>
    </div>

    <div id="settingsReorderPanel" class="subcard hidden">
      <div id="settingsReorderList"></div>
      <button id="settingsSaveOrderBtn">Save Order</button>
    </div>
  </div>

  <div class="card subcard">
    <h1>Account</h1>
    <button id="settingsLogoutBtn" class="secondary">Log Out</button>
    <button id="settingsStartOverBtn" class="danger">Start Over</button>
    <div id="settingsResetStatus" class="status"></div>
  </div>
</div>
</div>
<script>
const API={
  base:"https://purrfect-budget-api.kardian.workers.dev",
  validate:"/api/auth/validate",
  state:"/api/budget/state",
  init:"/api/budget/init",
  tx:"/api/budget/transactions",
  cats:"/api/budget/categories",
  reset:"/api/budget/reset"
};

const IDB={name:"pwa-budget-app",version:4,store:"kv"};
const KEY_TOKEN="token",KEY_NAME="name";

function openDb(){
  return new Promise((res)=>{
    const r=indexedDB.open(IDB.name,IDB.version);
    r.onupgradeneeded=()=>r.result.createObjectStore(IDB.store);
    r.onsuccess=()=>res(r.result);
  });
}
async function idbGet(k){const d=await openDb();return new Promise(r=>{const t=d.transaction(IDB.store);t.objectStore(IDB.store).get(k).onsuccess=e=>r(e.target.result)})}
async function idbSet(k,v){const d=await openDb();d.transaction(IDB.store,"readwrite").objectStore(IDB.store).put(v,k)}

const $=id=>document.getElementById(id);
const join=(p)=>API.base+p;
const hdr=t=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"});
let CURRENT_STATE=null;

function addWizRow(n="",b=""){
  const d=document.createElement("div");
  d.innerHTML=`<input placeholder="Category" value="${n}">
               <input placeholder="$0.00" value="${b}">`;
  $("wizCatList").appendChild(d);
}
function initWizard(){
  $("wizCatList").innerHTML="";
  addWizRow("Groceries","300");
  addWizRow("Gas","120");
  $("wizStep1").classList.remove("hidden");
  $("wizStep2").classList.add("hidden");
  $("wizStep3").classList.add("hidden");
}

async function submitInit(){
  const cats=[...$("wizCatList").children].map((r,i)=>({
    name:r.children[0].value,
    sort_order:i+1,
    budget_dollars:r.children[1].value.replace(/[^0-9.]/g,"")
  }));
  const body={
    period_type:$("wizPeriodType").value,
    period_anchor_date:new Date().toISOString().slice(0,10),
    categories:cats
  };
  const t=await idbGet(KEY_TOKEN);
  await fetch(join(API.init),{method:"POST",headers:hdr(t),body:JSON.stringify(body)});
  bootstrap();
}

function renderDashboard(state){
  CURRENT_STATE=state;
  $("periodLabel").textContent=state.period.start_ts.slice(0,10)+" → "+state.period.end_ts.slice(0,10);
  $("catTableBody").innerHTML="";
  state.categories.forEach(c=>{
    $("catTableBody").innerHTML+=
      `<tr><td>${c.name}</td>
           <td class="right">$${(c.spent_cents/100).toFixed(2)}</td>
           <td class="right">$${(c.remaining_cents/100).toFixed(2)}</td></tr>`;
  });
}
async function bootstrap(){
  const t=await idbGet(KEY_TOKEN);
  if(!t){$("authView").classList.remove("hidden");return}
  const ok=await fetch(join(API.validate),{headers:hdr(t)});
  if(!ok.ok){$("authView").classList.remove("hidden");return}
  const st=await fetch(join(API.state),{headers:hdr(t)}).then(r=>r.json());
  $("authView").classList.add("hidden");
  if(!st.initialized){
    $("noCategoriesView").classList.remove("hidden");
    initWizard();
    return;
  }
  $("appView").classList.remove("hidden");
  $("dashboardView").classList.remove("hidden");
  renderDashboard(st);
}

$("saveTokenBtn").onclick=async()=>{
  await idbSet(KEY_NAME,$("userNameInput").value);
  await idbSet(KEY_TOKEN,$("tokenInput").value);
  bootstrap();
};
$("toggleTokenBtn").onclick=()=>{$("tokenInput").type=$("tokenInput").type==="password"?"text":"password"};
$("wizAddCat").onclick=()=>addWizRow();
$("wizNext1").onclick=()=>{$("wizStep1").classList.add("hidden");$("wizStep2").classList.remove("hidden")};
$("wizNext2").onclick=()=>{$("wizStep2").classList.add("hidden");$("wizStep3").classList.remove("hidden")};
$("wizSubmit").onclick=submitInit;

bootstrap();
</script>
</body>
</html>
