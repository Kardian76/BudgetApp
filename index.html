<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1320" />
  <title>Purrfect Budget</title>

  <style>
    :root{
      --bg0:#070b12;
      --bg1:#0b1320;
      --card:rgba(255,255,255,0.06);
      --cardBorder:rgba(255,255,255,0.10);
      --text:#e9eef7;
      --muted:rgba(233,238,247,0.82);
      --muted2:rgba(233,238,247,0.68);
      --fieldBg:rgba(10,14,22,0.72);
      --fieldBorder:rgba(255,255,255,0.12);
      --fieldBorderHover:rgba(255,255,255,0.18);
      --fieldBorderFocus:rgba(130,190,255,0.65);
      --primary:#2d6cdf;
      --primary2:#1f57c8;
      --danger:#ffb4b4;
      --success:#b6ffcf;
      --shadow:0 18px 46px rgba(0,0,0,0.38);
      --radius:16px;
      --radiusField:12px;
      --ring:0 0 0 4px rgba(45,108,223,0.16);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 480px at 10% 0%, rgba(45,108,223,0.22), transparent 60%),
        radial-gradient(720px 360px at 90% 10%, rgba(182,255,207,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    h1{ font-size:18px; margin:0 0 10px; }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.045));
      border:1px solid var(--cardBorder);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
    }

    .subcard{ margin-top:14px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:820px){ .grid2{ grid-template-columns:1fr; } }

    label{ display:block; margin:12px 0 6px; font-size:13px; color:var(--muted); }
    input,select{
      width:100%;
      padding:11px 12px;
      border-radius:var(--radiusField);
      border:1px solid var(--fieldBorder);
      background:var(--fieldBg);
      color:var(--text);
      outline:none;
    }

    button{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      cursor:pointer;
      font-weight:650;
      color:#fff;
      background:linear-gradient(180deg,var(--primary),var(--primary2));
    }
    button.secondary{ background:rgba(255,255,255,0.1); color:var(--text); }
    button.danger{ background:#8b1e1e; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .status{ font-size:13px; color:var(--muted2); margin-top:10px; }
    .ok{ color:var(--success); }
    .error{ color:var(--danger); }

    .hidden{ display:none !important; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.1); }
    th{ text-align:left; font-size:13px; color:var(--muted); }
    td.right,th.right{ text-align:right; }

    .tableScroll{ max-height:360px; overflow:auto; }

    /* Modal */
    body.modalOpen{ overflow:hidden; }
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.55);
      display:flex; align-items:flex-start; justify-content:center;
      padding:20px;
      z-index:1000;
    }
    .modal{
      background:var(--bg1);
      border-radius:16px;
      width:100%;
      max-width:720px;
      max-height:calc(100vh - 40px);
      overflow:auto;
      padding:18px;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
    }
    .modalSection{ margin-top:14px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Purrfect Budget</h1>

  <!-- AUTH -->
  <div id="authView" class="card hidden">
    <label for="userNameInput">Your name</label>
    <input id="userNameInput" type="text" placeholder="e.g., Jeremy" />

    <label for="tokenInput">Bearer Token</label>
    <input id="tokenInput" type="password" placeholder="Paste token…" />

    <div class="row">
      <button id="saveTokenBtn">Save & Continue</button>
      <button id="toggleTokenBtn" class="secondary">Show</button>
    </div>
    <div id="authStatus" class="status"></div>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div id="dashboardView">

      <!-- Budget Summary -->
      <div class="card">
        <h1>Budget Summary</h1>
        <div class="status">Period: <strong id="periodLabel"></strong></div>

        <div class="tableScroll">
          <table>
            <thead>
              <tr>
                <th>Category</th>
                <th class="right">Spent</th>
                <th class="right">Remaining</th>
              </tr>
            </thead>
            <tbody id="catTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid2">
        <!-- Add Transaction -->
        <div class="card subcard">
          <h1>Add Transaction</h1>

          <label for="txType">Type</label>
          <select id="txType">
            <option value="expense">Expense</option>
            <option value="refund">Refund</option>
          </select>

          <label for="txCategory">Category</label>
          <select id="txCategory"></select>

          <label for="txAmount">Amount</label>
          <input id="txAmount" type="text" placeholder="$0.00" />

          <label for="txNote">Note (optional)</label>
          <input id="txNote" type="text" />

          <div class="row">
            <button id="txSubmitBtn">Save</button>
          </div>
          <div id="txStatus" class="status"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings FAB -->
  <button id="openSettingsBtn"
    style="position:fixed; right:20px; bottom:20px; z-index:900;">
    Settings
  </button>

  <div id="globalStatus" class="status"></div>
</div>
<div id="settingsOverlay" class="modalOverlay hidden" aria-hidden="true">
  <div class="modal">
    <div class="modalHeader">
      <h1>Settings</h1>
      <button id="settingsCloseBtn" class="secondary">Close</button>
    </div>

    <div class="modalSection card">
      <h1>Budget Categories</h1>

      <div class="row">
        <button id="settingsAddOpenBtn" class="secondary">Add Budget Categories</button>
        <button id="settingsReorderBtn" class="secondary">Reorder Budget Categories</button>
        <button id="settingsApplyRemoveBtn">Apply Removals</button>
      </div>

      <div id="settingsCatList"></div>
      <div id="settingsCatStatus" class="status"></div>

      <div id="settingsAddPanel" class="subcard hidden">
        <label>Category name</label>
        <input id="settingsNewCatName" />
        <label>Starting budget</label>
        <input id="settingsNewCatBudget" placeholder="$0.00" />
        <div class="row">
          <button id="settingsAddCatBtn">Add</button>
        </div>
      </div>

      <div id="settingsReorderPanel" class="subcard hidden">
        <div id="settingsReorderList"></div>
        <button id="settingsSaveOrderBtn">Save Order</button>
      </div>
    </div>

    <div class="modalSection card">
      <h1>Account</h1>
      <div class="row">
        <button id="settingsLogoutBtn" class="secondary">Log Out</button>
        <button id="settingsStartOverBtn" class="danger">Start Over</button>
      </div>
      <div id="settingsResetStatus" class="status"></div>
    </div>
  </div>
</div>
<script>
const $ = (id)=>document.getElementById(id);

const IDB={ name:"pwa-budget-app", version:3, store:"auth", key:"bearerToken" };

function openDb(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(IDB.name,IDB.version);
    r.onupgradeneeded=()=>{ if(!r.result.objectStoreNames.contains(IDB.store)) r.result.createObjectStore(IDB.store); };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}
async function idbGet(k){ const db=await openDb(); return new Promise(r=>{ const q=db.transaction(IDB.store).objectStore(IDB.store).get(k); q.onsuccess=()=>r(q.result||null); });}
async function idbSet(k,v){ const db=await openDb(); return new Promise(r=>{ const q=db.transaction(IDB.store,"readwrite").objectStore(IDB.store).put(v,k); q.onsuccess=()=>r(); });}
async function idbDel(k){ const db=await openDb(); return new Promise(r=>{ const q=db.transaction(IDB.store,"readwrite").objectStore(IDB.store).delete(k); q.onsuccess=()=>r(); });}

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function setStatus(el,msg,kind){ el.textContent=msg||""; el.className="status"+(kind?" "+kind:""); }

const settingsOverlay=$("settingsOverlay");
$("openSettingsBtn").onclick=()=>{ document.body.classList.add("modalOpen"); show(settingsOverlay); };
$("settingsCloseBtn").onclick=()=>{ document.body.classList.remove("modalOpen"); hide(settingsOverlay); };
let CURRENT_CATEGORIES=[];

function renderDashboard(state){
  CURRENT_CATEGORIES=state.categories||[];
  $("periodLabel").textContent=
    state.period ? state.period.start_ts.slice(0,10)+" → "+state.period.end_ts.slice(0,10) : "";

  const body=$("catTableBody");
  body.innerHTML="";
  CURRENT_CATEGORIES.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=
      `<td>${c.name}</td>
       <td class="right">$${(c.spent_cents/100).toFixed(2)}</td>
       <td class="right">$${(c.remaining_cents/100).toFixed(2)}</td>`;
    body.appendChild(tr);
  });

  const sel=$("txCategory");
  sel.innerHTML="";
  CURRENT_CATEGORIES.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.category_id; o.textContent=c.name;
    sel.appendChild(o);
  });
}
async function bootstrap(){
  const token=await idbGet(IDB.key);
  if(!token){ show($("authView")); return; }
  show($("appView"));
  // fetch state from API here → renderDashboard(...)
}

$("saveTokenBtn").onclick=async()=>{
  await idbSet(IDB.key,$("tokenInput").value.trim());
  hide($("authView")); show($("appView"));
};

bootstrap();
</script>
</body>
</html>
