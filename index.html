<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1320" />
  <title>Purrfect Budget</title>

  <style>
    /* ---------------- Banking-app style theme ---------------- */
    :root{
      --bg0:#070b12;
      --bg1:#0b1320;
      --card:rgba(255,255,255,0.06);
      --cardBorder:rgba(255,255,255,0.10);
      --text:#e9eef7;
      --muted:rgba(233,238,247,0.82);
      --muted2:rgba(233,238,247,0.68);
      --fieldBg:rgba(10,14,22,0.72);
      --fieldBorder:rgba(255,255,255,0.12);
      --fieldBorderHover:rgba(255,255,255,0.18);
      --fieldBorderFocus:rgba(130,190,255,0.65);
      --primary:#2d6cdf;
      --primary2:#1f57c8;
      --danger:#ffb4b4;
      --success:#b6ffcf;
      --shadow: 0 18px 46px rgba(0,0,0,0.38);
      --shadow2: 0 10px 24px rgba(0,0,0,0.28);
      --radius:16px;
      --radiusField:12px;
      --ring: 0 0 0 4px rgba(45,108,223,0.16);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 480px at 10% 0%, rgba(45,108,223,0.22), transparent 60%),
        radial-gradient(720px 360px at 90% 10%, rgba(182,255,207,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.045));
      border: 1px solid var(--cardBorder);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .subcard{
      margin-top: 12px;
      box-shadow: var(--shadow2);
      border-radius: var(--radius);
    }

    h1{
      font-size: 18px;
      margin: 0 0 10px;
      letter-spacing: 0.2px;
    }

    p{ margin: 10px 0; line-height: 1.35; color: var(--muted); }
    label{ display:block; margin: 12px 0 6px; font-size: 13px; color: var(--muted); }

    /* Banking-style inputs: consistent everywhere */
    input[type="text"], input[type="password"], select{
      width: 100%;
      padding: 11px 12px;
      border-radius: var(--radiusField);
      border: 1px solid var(--fieldBorder);
      background: var(--fieldBg);
      color: var(--text);
      outline: none;
      transition: border-color .16s ease, box-shadow .16s ease, transform .06s ease;
    }

    input[type="text"]:hover, input[type="password"]:hover, select:hover{
      border-color: var(--fieldBorderHover);
    }

    input[type="text"]:focus, input[type="password"]:focus, select:focus{
      border-color: var(--fieldBorderFocus);
      box-shadow: var(--ring);
    }

    input:disabled{
      opacity: .82;
      cursor: not-allowed;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    button{
      appearance:none;
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      cursor: pointer;
      color: #fff;
      font-weight: 650;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 18px rgba(45,108,223,0.22);
      transition: transform .06s ease, filter .16s ease, opacity .16s ease;
    }

    button:hover{ filter: brightness(1.05); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(255,255,255,0.10);
      color: var(--text);
      box-shadow: none;
      border: 1px solid rgba(255,255,255,0.12);
    }

    button:disabled{ opacity: .55; cursor: not-allowed; }

    .status{ margin-top: 12px; font-size: 13px; color: var(--muted2); }
    .error{ color: var(--danger); }
    .ok{ color: var(--success); }
    .hidden{ display:none; }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; }

    pre{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:auto;
    }

    /* ---------------- Step 2: phone-first one-line rows ---------------- */
    .catRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:nowrap; /* always attempt one line */
    }

    /* Critical override: cancel global width:100% for row inputs */
    .catRow input{
      width:auto;
      min-width:0; /* allow shrink */
    }

    /* Category always dominates */
    .catRow .catName{
      flex: 1 1 auto;
      min-width: 0;
      max-width: 520px;
    }

    /* Budget stays compact */
    .catRow .catBudget{
      flex: 0 0 96px;
      width: 96px;
      max-width: 96px;
      text-align:right;
      padding-left: 10px;
      padding-right: 10px;
    }

    .catRow .wizRemoveCat{
      flex: 0 0 auto;
      white-space: nowrap;
      padding: 11px 12px;
    }

    @media (max-width: 420px){
      .wrap{ padding: 14px; }
      .catRow .catBudget{
        flex-basis: 88px;
        width: 88px;
        max-width: 88px;
        padding-left: 9px;
        padding-right: 9px;
      }
    }

    @media (max-width: 360px){
      h1{ font-size: 17px; }
    }

    /* ---------------- Dashboard layout helpers (no font-size changes) ---------------- */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 680px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--muted);
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .table th, .table td{
      text-align:left;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .table th{
      color: var(--muted);
      background: rgba(255,255,255,0.05);
      font-weight: 650;
    }
    .table tr:last-child td{ border-bottom: 0; }

    .right{ text-align:right; }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Purrfect Budget</h1>

    <!-- ================= AUTH ================= -->
    <div id="authView" class="hidden">
      <p class="status">Enter your bearer token. It will be stored locally in IndexedDB.</p>

      <label for="tokenInput">Bearer Token</label>
      <input id="tokenInput" type="password" placeholder="Paste token…" autocomplete="off" />

      <div class="row">
        <button id="saveTokenBtn" type="button">Save Token</button>
        <button id="toggleTokenBtn" class="secondary" type="button">Show</button>
      </div>

      <div id="authStatus" class="status"></div>
    </div>

    <!-- ================= APP ================= -->
    <div id="appView" class="hidden">
      <!-- Top status line (we will keep the element, but it will be blank during normal operation) -->
      <p id="appStatus" class="status"></p>

      <!-- ===== Main dashboard (shown when initialized) ===== -->
      <div id="dashboardView" class="hidden">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="pill">
            <span class="muted2">Period</span>
            <span id="periodLabel" style="color:var(--text); font-weight:650;"></span>
          </div>
          <!-- Contributor indicator removed -->
        </div>

        <div class="grid2">
          <!-- Summary card removed -->

          <div class="card subcard">
            <h1 style="margin:0 0 10px;">Add transaction</h1>

            <label for="contribLabel">Your name / device label (saved locally)</label>
            <input id="contribLabel" type="text" placeholder="e.g., Jeremy (iPhone)" />

            <label for="txCategory">Category</label>
            <select id="txCategory"></select>

            <div class="row">
              <div style="flex:1 1 160px; min-width: 160px;">
                <label for="txAmount">Amount</label>
                <input id="txAmount" type="text" inputmode="decimal" placeholder="$0.00" />
              </div>

              <div style="flex:1 1 160px; min-width: 160px;">
                <label for="txType">Type</label>
                <select id="txType">
                  <option value="expense" selected>Expense</option>
                  <option value="refund">Refund</option>
                </select>
              </div>
            </div>

            <label for="txNote">Note (optional)</label>
            <input id="txNote" type="text" placeholder="e.g., Groceries at Target" />

            <div class="row">
              <button id="txSubmitBtn" type="button">Save</button>
              <button id="txClearBtn" class="secondary" type="button">Clear</button>
              <button id="refreshBtn" class="secondary" type="button">Refresh</button>
            </div>
            <div id="txStatus" class="status"></div>
          </div>
        </div>

        <div class="card subcard">
          <h1 style="margin:0 0 10px;">Categories</h1>
          <table class="table" id="catTable">
            <thead>
              <tr>
                <th>Category</th>
                <th class="right">Budget</th>
                <th class="right">Spent</th>
                <th class="right">Remaining</th>
              </tr>
            </thead>
            <tbody id="catTableBody"></tbody>
          </table>
        </div>

        <!-- Recent transactions card removed -->
      </div>

      <!-- ===== Wizard (shown when not initialized) ===== -->
      <div id="noCategoriesView" class="hidden">
        <p class="ok">Welcome. Let’s initialize your budget.</p>
        <!-- ---------- STEP 1 ---------- -->
        <div id="wizStep1" class="card subcard">
          <h1>Step 1 — Budget period</h1>

          <label for="wizPeriodType">Period Type</label>
          <select id="wizPeriodType">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly" selected>Every Two Weeks</option>
            <option value="semi_monthly">Twice a Month</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
          </select>

          <label for="wizStartDate">Start Date (MM-DD-YYYY)</label>
          <input id="wizStartDate" type="text" placeholder="MM-DD-YYYY" inputmode="numeric" />

          <div class="row">
            <button id="wizNext1" type="button">Next</button>
          </div>
          <div id="wizStatus1" class="status"></div>
        </div>

        <!-- ---------- STEP 2 ---------- -->
        <div id="wizStep2" class="card subcard hidden">
          <h1>Step 2 — Categories</h1>
          <p class="status" style="margin-top:0;">Enter 1–10 categories with starting budgets.</p>

          <div id="wizCatList"></div>

          <div class="row">
            <button id="wizAddCat" class="secondary" type="button">Add Category</button>
            <button id="wizBack2" class="secondary" type="button">Back</button>
            <button id="wizNext2" type="button">Next</button>
          </div>
          <div id="wizStatus2" class="status"></div>
        </div>

        <!-- ---------- STEP 3 ---------- -->
        <div id="wizStep3" class="card subcard hidden">
          <h1>Step 3 — Confirm your setup</h1>

          <p class="status" style="margin-top:0;">
            Please confirm these details before saving your initial budget.
          </p>

          <!-- Friendly review (no code) -->
          <div id="wizReviewCard" style="margin-top:10px;">
            <div class="status" id="wizReviewSummary" style="margin-top:0;"></div>

            <div class="card subcard" style="margin-top:10px;">
              <h1 style="margin:0 0 10px;">Budget period</h1>
              <div class="status" id="wizReviewPeriod"></div>
              <div class="status" id="wizReviewStartDate"></div>
            </div>

            <div class="card subcard" style="margin-top:10px;">
              <h1 style="margin:0 0 10px;">Categories</h1>
              <div id="wizReviewCategories"></div>
              <div class="status" id="wizReviewTotal" style="margin-top:10px;"></div>
            </div>

            <div class="status" style="margin-top:12px;">
              Note: You can change categories and amounts later. This is just your starting setup.
            </div>
          </div>

          <!-- Optional: keep JSON for debugging only (hidden) -->
          <pre id="wizReviewJson" class="mono hidden" style="white-space:pre-wrap;"></pre>

          <div class="row">
            <button id="wizBack3" class="secondary" type="button">Back</button>
            <button id="wizSubmit" type="button">Initialize</button>
          </div>
          <div id="wizStatus3" class="status"></div>
        </div>
      </div>

      <div class="row">
        <button id="logoutBtn" class="secondary" type="button">Log Out</button>
        <button id="retryBtn" class="secondary" type="button">Retry</button>
      </div>
    </div>

    <div id="globalStatus" class="status"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = {
  baseUrl: "https://purrfect-budget-api.kardian.workers.dev",
  validatePath: "/api/auth/validate",
  statePath: "/api/budget/state",
  initPath: "/api/budget/init",
  txPath: "/api/budget/transactions",
  timeoutMs: 12000
};
/* ================= INDEXEDDB ================= */
const IDB = {
  name: "pwa-budget-app",
  version: 2,              // bump forward; never downgrade
  store: "auth",
  key: "bearerToken"
};

function openDb() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(IDB.name, IDB.version);

    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(IDB.store)) db.createObjectStore(IDB.store);
    };

    req.onsuccess = () => resolve(req.result);

    req.onerror = () => {
      const err = req.error;
      const msg = String(err?.message || err || "");
      if (err?.name === "VersionError" || msg.toLowerCase().includes("higher version")) {
        try { indexedDB.deleteDatabase(IDB.name); } catch {}
      }
      reject(err);
    };
  });
}

async function idbGet(key) {
  const db = await openDb();
  try {
    return await new Promise((resolve, reject) => {
      const tx = db.transaction(IDB.store, "readonly");
      const store = tx.objectStore(IDB.store);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result ?? null);
      req.onerror = () => reject(req.error);
    });
  } finally { db.close(); }
}

async function idbSet(key, value) {
  const db = await openDb();
  try {
    return await new Promise((resolve, reject) => {
      const tx = db.transaction(IDB.store, "readwrite");
      const store = tx.objectStore(IDB.store);
      const req = store.put(value, key);
      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  } finally { db.close(); }
}

async function idbDel(key) {
  const db = await openDb();
  try {
    return await new Promise((resolve, reject) => {
      const tx = db.transaction(IDB.store, "readwrite");
      const store = tx.objectStore(IDB.store);
      const req = store.delete(key);
      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  } finally { db.close(); }
}

/* ================= Local settings (non-sensitive) ================= */
const LS = {
  contribLabel: "purrfect_contrib_label",
  deviceId: "purrfect_device_id"
};

function lsGet(key) {
  try { return localStorage.getItem(key); } catch { return null; }
}
function lsSet(key, value) {
  try { localStorage.setItem(key, value); return true; } catch { return false; }
}

function getOrCreateDeviceId() {
  let v = lsGet(LS.deviceId);
  if (v && v.length >= 8) return v;
  v = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
  lsSet(LS.deviceId, v);
  return v;
}

function getContribLabel() {
  return String(lsGet(LS.contribLabel) || "").trim();
}

function setContribLabel(v) {
  lsSet(LS.contribLabel, String(v || "").trim().slice(0, 80));
}

/* ================= DOM ================= */
const $ = (id) => document.getElementById(id);

const authView = $("authView");
const tokenInput = $("tokenInput");
const saveTokenBtn = $("saveTokenBtn");
const toggleTokenBtn = $("toggleTokenBtn");
const authStatus = $("authStatus");

const appView = $("appView");
const appStatus = $("appStatus");
const dashboardView = $("dashboardView");
const noCategoriesView = $("noCategoriesView");

const logoutBtn = $("logoutBtn");
const retryBtn = $("retryBtn");
const globalStatus = $("globalStatus");

/* Dashboard DOM */
const periodLabelEl = $("periodLabel");

const txCategory = $("txCategory");
const txAmount = $("txAmount");
const txType = $("txType");
const txNote = $("txNote");
const txSubmitBtn = $("txSubmitBtn");
const txClearBtn = $("txClearBtn");
const refreshBtn = $("refreshBtn");
const txStatus = $("txStatus");

const catTableBody = $("catTableBody");

const contribLabel = $("contribLabel");

/* Wizard DOM */
const wizStep1 = $("wizStep1");
const wizStep2 = $("wizStep2");
const wizStep3 = $("wizStep3");

const wizPeriodType = $("wizPeriodType");
const wizStartDate = $("wizStartDate");

const wizCatList = $("wizCatList");
const wizReviewJson = $("wizReviewJson");

/* Friendly Step 3 review DOM */
const wizReviewSummary = $("wizReviewSummary");
const wizReviewPeriod = $("wizReviewPeriod");
const wizReviewStartDate = $("wizReviewStartDate");
const wizReviewCategories = $("wizReviewCategories");
const wizReviewTotal = $("wizReviewTotal");

const wizNext1 = $("wizNext1");
const wizBack2 = $("wizBack2");
const wizNext2 = $("wizNext2");
const wizAddCat = $("wizAddCat");

const wizBack3 = $("wizBack3");
const wizSubmit = $("wizSubmit");

const wizStatus1 = $("wizStatus1");
const wizStatus2 = $("wizStatus2");
const wizStatus3 = $("wizStatus3");

/* ================= UI HELPERS ================= */
function show(el) { if (el) el.classList.remove("hidden"); }
function hide(el) { if (el) el.classList.add("hidden"); }

function setStatus(el, msg, kind) {
  if (!el) return;
  el.textContent = msg || "";
  el.classList.remove("error", "ok");
  if (kind) el.classList.add(kind);
}
function setBusy(isBusy) {
  const btns = [
    saveTokenBtn, toggleTokenBtn, logoutBtn, retryBtn,
    wizNext1, wizBack2, wizNext2, wizAddCat, wizBack3, wizSubmit,
    txSubmitBtn, txClearBtn, refreshBtn
  ].filter(Boolean);
  for (const b of btns) b.disabled = !!isBusy;
}

function showAuth(message = "", isError = false) {
  show(authView);
  hide(appView);
  setStatus(authStatus, message, isError ? "error" : "");
  setStatus(globalStatus, "");
  tokenInput?.focus();
}

function showApp(message = "") {
  hide(authView);
  show(appView);
  setStatus(appStatus, message);
}

/* ================= URL + FETCH ================= */
function joinUrl(base, path) {
  return base.replace(/\/+$/, "") + "/" + path.replace(/^\/+/, "");
}

function authHeaders(token) {
  return {
    "Authorization": `Bearer ${token}`,
    "Content-Type": "application/json"
  };
}

function fetchWithTimeout(url, options = {}) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), API.timeoutMs);
  return fetch(url, { ...options, signal: controller.signal })
    .finally(() => clearTimeout(id));
}

async function safeText(resp) {
  try { return await resp.text(); } catch { return ""; }
}

/* ================= API ================= */
async function validateToken(token) {
  const url = joinUrl(API.baseUrl, API.validatePath);
  const resp = await fetchWithTimeout(url, { method: "GET", headers: authHeaders(token) });
  if (resp.ok) return true;
  if (resp.status === 401 || resp.status === 403) return false;
  const t = await safeText(resp);
  throw new Error(`Token validate failed (${resp.status}): ${t || resp.statusText}`);
}

async function fetchState(token) {
  const url = joinUrl(API.baseUrl, API.statePath);
  const resp = await fetchWithTimeout(url, { method: "GET", headers: authHeaders(token) });

  if (!resp.ok) {
    if (resp.status === 401 || resp.status === 403) return { authFailed: true, state: null };
    const t = await safeText(resp);
    throw new Error(`State failed (${resp.status}): ${t || resp.statusText}`);
  }
  return { authFailed: false, state: await resp.json().catch(() => ({})) };
}

async function postInit(token, payload) {
  const url = joinUrl(API.baseUrl, API.initPath);
  const resp = await fetchWithTimeout(url, {
    method: "POST",
    headers: authHeaders(token),
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    if (resp.status === 401 || resp.status === 403) return { authFailed: true, result: null };
    const t = await safeText(resp);
    throw new Error(`Init failed (${resp.status}): ${t || resp.statusText}`);
  }
  return { authFailed: false, result: await resp.json().catch(() => ({})) };
}

async function postTransaction(token, body) {
  const url = joinUrl(API.baseUrl, API.txPath);
  const resp = await fetchWithTimeout(url, {
    method: "POST",
    headers: authHeaders(token),
    body: JSON.stringify(body)
  });

  if (!resp.ok) {
    if (resp.status === 401 || resp.status === 403) return { authFailed: true, result: null };
    const t = await safeText(resp);
    throw new Error(`Transaction failed (${resp.status}): ${t || resp.statusText}`);
  }
  return { authFailed: false, result: await resp.json().catch(() => ({})) };
}

/* ================= DATE HELPERS (UI MM-DD-YYYY) ================= */
const pad2 = (n) => String(n).padStart(2, "0");

function todayYMD() {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function ymdToMdy(ymd) {
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(ymd || ""));
  if (!m) return "";
  return `${m[2]}-${m[3]}-${m[1]}`;
}

function mdyToYmd(mdy) {
  const s = String(mdy || "").trim();
  const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s);
  if (!m) return null;

  const mm = Number(m[1]), dd = Number(m[2]), yyyy = Number(m[3]);
  if (yyyy < 1900 || yyyy > 2100) return null;
  if (mm < 1 || mm > 12) return null;
  if (dd < 1 || dd > 31) return null;

  const dt = new Date(yyyy, mm - 1, dd);
  if (dt.getFullYear() !== yyyy || dt.getMonth() !== (mm - 1) || dt.getDate() !== dd) return null;

  return `${yyyy}-${pad2(mm)}-${pad2(dd)}`;
}

function periodUsesStartDate(periodType) {
  return periodType === "weekly" || periodType === "biweekly" || periodType === "quarterly";
}

function disabledStartDateMessage(periodType) {
  switch (periodType) {
    case "daily": return "Not needed for Daily budgets";
    case "monthly": return "Not needed for Monthly budgets";
    case "semi_monthly": return "Not needed for Twice-a-Month budgets";
    default: return "Not needed for this period type";
  }
}

function updateStartDateAvailability() {
  const pt = (wizPeriodType?.value || "").trim();
  const uses = periodUsesStartDate(pt);

  if (!wizStartDate) return;

  if (uses) {
    const prev = wizStartDate.dataset.prevValue;
    wizStartDate.disabled = false;
    wizStartDate.placeholder = "MM-DD-YYYY";
    if (prev && wizStartDate.value.startsWith("Not needed")) {
      wizStartDate.value = prev;
    }
    if (!wizStartDate.value || wizStartDate.value.startsWith("Not needed")) {
      wizStartDate.value = ymdToMdy(todayYMD());
    }
  } else {
    if (wizStartDate.value && !wizStartDate.value.startsWith("Not needed")) {
      wizStartDate.dataset.prevValue = wizStartDate.value;
    }
    wizStartDate.disabled = true;
    wizStartDate.value = disabledStartDateMessage(pt);
  }
}

/* ================= Currency helpers ================= */
function dollarsStringToCents(v) {
  const s = String(v || "").trim().replace(/[^0-9.]/g, "");
  if (!s) return null;
  const n = Number(s);
  if (!Number.isFinite(n)) return null;
  return Math.round(n * 100);
}

function normalizeBudgetDisplay(s) {
  const raw = String(s || "").trim().replace(/[^0-9.]/g, "");
  if (!raw) return "";
  const n = Number(raw);
  if (!Number.isFinite(n)) return "";
  return "$" + n.toFixed(2);
}

function parseTxAmountToCents() {
  const cents = dollarsStringToCents(txAmount.value);
  if (cents === null) return null;
  if (cents <= 0) return null;
  return cents;
}

/* ================= WIZARD ================= */
function showStep(stepIndex) {
  [wizStep1, wizStep2, wizStep3].forEach((el, idx) => {
    if (!el) return;
    el.classList.toggle("hidden", idx !== stepIndex);
  });
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function addWizCategoryRow(name = "", dollars = "") {
  const row = document.createElement("div");
  row.className = "catRow";

  const display = dollars ? normalizeBudgetDisplay(dollars) : "";

  row.innerHTML = `
    <input class="catName" type="text" placeholder="Category" value="${escapeHtml(name)}" />
    <input class="catBudget"
           type="text"
           inputmode="decimal"
           placeholder="$0.00"
           value="${escapeHtml(display)}" />
    <button class="secondary wizRemoveCat" type="button">Remove</button>
  `;

  const b = row.querySelector(".catBudget");
  b.addEventListener("blur", () => { b.value = normalizeBudgetDisplay(b.value); });

  row.querySelector(".wizRemoveCat").addEventListener("click", () => row.remove());
  wizCatList.appendChild(row);
}

function readCategoriesFromUI() {
  const rows = Array.from(wizCatList.querySelectorAll(".catRow"));
  return rows.map((r, idx) => {
    const name = r.querySelector(".catName")?.value?.trim() || "";
    const budgetRaw = r.querySelector(".catBudget")?.value || "";
    const budgetCents = dollarsStringToCents(budgetRaw);
    const budgetDollars = (budgetCents === null) ? "" : (budgetCents / 100).toFixed(2);
    return { name, budget_dollars: budgetDollars, sort_order: idx + 1 };
  }).filter(c => c.name.length > 0);
}
function validateStep1() {
  const pt = (wizPeriodType.value || "").trim();
  const allowed = new Set(["daily", "weekly", "biweekly", "semi_monthly", "monthly", "quarterly"]);
  if (!allowed.has(pt)) return "Invalid period type.";

  if (periodUsesStartDate(pt)) {
    const ymd = mdyToYmd(wizStartDate.value);
    if (!ymd) return "Start Date must be MM-DD-YYYY.";
  }
  return null;
}

function validateStep2() {
  const cats = readCategoriesFromUI();
  if (cats.length < 1 || cats.length > 10) return "Please provide 1 to 10 categories.";

  const seen = new Set();
  for (const c of cats) {
    if (!c.name) return "Category name cannot be blank.";
    if (c.name.length > 64) return `Category name too long: ${c.name}`;
    if (!c.budget_dollars || !String(c.budget_dollars).trim()) return `Please enter a budget for: ${c.name}`;

    const k = c.name.toLowerCase();
    if (seen.has(k)) return `Duplicate category name: ${c.name}`;
    seen.add(k);
  }
  return null;
}

function effectiveStartDateYmd() {
  const pt = (wizPeriodType.value || "").trim();
  if (!periodUsesStartDate(pt)) return todayYMD();
  return mdyToYmd(wizStartDate.value);
}

function buildInitPayload() {
  return {
    period_type: (wizPeriodType.value || "").trim(),
    period_anchor_date: effectiveStartDateYmd(),
    categories: readCategoriesFromUI().map(c => ({
      name: c.name,
      sort_order: c.sort_order,
      budget_dollars: c.budget_dollars
    }))
  };
}

function periodLabel(pt) {
  switch (pt) {
    case "daily": return "Daily";
    case "weekly": return "Weekly";
    case "biweekly": return "Every Two Weeks";
    case "semi_monthly": return "Twice a Month";
    case "monthly": return "Monthly";
    case "quarterly": return "Quarterly";
    default: return pt || "—";
  }
}

function fmtUsdFromDollarsString(d) {
  const n = Number(d);
  if (!Number.isFinite(n)) return "—";
  return `$${n.toFixed(2)}`;
}

function renderReview() {
  const payload = buildInitPayload();

  if (wizReviewJson) {
    wizReviewJson.textContent = JSON.stringify(payload, null, 2);
  }

  const pt = payload.period_type;
  const uses = periodUsesStartDate(pt);

  const catCount = payload.categories?.length || 0;
  if (wizReviewSummary) {
    wizReviewSummary.textContent = `You’re about to initialize your budget with ${catCount} ${catCount === 1 ? "category" : "categories"}.`;
  }

  if (wizReviewPeriod) {
    wizReviewPeriod.textContent = `Period type: ${periodLabel(pt)}`;
  }

  if (wizReviewStartDate) {
    if (uses) {
      wizReviewStartDate.textContent = `Start date: ${ymdToMdy(payload.period_anchor_date)}`;
      wizReviewStartDate.classList.remove("hidden");
    } else {
      wizReviewStartDate.textContent = `Start date: Not required for ${periodLabel(pt)} budgets`;
      wizReviewStartDate.classList.remove("hidden");
    }
  }

  let total = 0;
  if (wizReviewCategories) {
    wizReviewCategories.innerHTML = "";
    for (const c of (payload.categories || [])) {
      const amt = Number(c.budget_dollars);
      if (Number.isFinite(amt)) total += amt;

      const row = document.createElement("div");
      row.className = "row";
      row.style.marginTop = "8px";
      row.style.justifyContent = "space-between";
      row.style.flexWrap = "nowrap";

      const left = document.createElement("div");
      left.textContent = c.name || "—";
      left.style.color = "var(--text)";
      left.style.fontWeight = "650";

      const right = document.createElement("div");
      right.textContent = fmtUsdFromDollarsString(c.budget_dollars);
      right.style.color = "var(--text)";
      right.style.fontVariantNumeric = "tabular-nums";

      row.appendChild(left);
      row.appendChild(right);
      wizReviewCategories.appendChild(row);
    }
  }

  if (wizReviewTotal) {
    wizReviewTotal.textContent = `Total starting budget: $${total.toFixed(2)}`;
  }
}

function initWizardDefaults() {
  if (!wizStartDate.value || wizStartDate.value === "MM-DD-YYYY") {
    wizStartDate.value = ymdToMdy(todayYMD());
  }

  if (wizCatList.children.length === 0) {
    addWizCategoryRow("Groceries", "300.00");
    addWizCategoryRow("Gas", "120.00");
  }

  updateStartDateAvailability();
  showStep(0);
}

/* ================= DASHBOARD STATE ================= */
let CURRENT_STATE = null;
let CURRENT_CATEGORIES = [];

function fmtPeriodRange(period) {
  if (!period || !period.start_ts || !period.end_ts) return "—";
  const s = String(period.start_ts).slice(0,10);
  const e = String(period.end_ts).slice(0,10);
  return `${ymdToMdy(s)} → ${ymdToMdy(e)}`;
}

function normalizeCategoriesFromState(state) {
  const arr = Array.isArray(state?.categories) ? state.categories : [];
  return arr.map(r => ({
    category_id: Number(r.category_id),
    name: String(r.name || "").trim(),
    budget_cents: Number(r.budget_cents) || 0,
    rollover_cents: Number(r.rollover_cents) || 0,
    spent_cents: Number(r.spent_cents) || 0,
    remaining_cents: Number(r.remaining_cents) || 0
  })).filter(c => c.name && Number.isFinite(c.category_id) && c.category_id > 0);
}

function renderDashboardFromState(state) {
  CURRENT_STATE = state || {};
  CURRENT_CATEGORIES = normalizeCategoriesFromState(CURRENT_STATE);

  if (periodLabelEl) periodLabelEl.textContent = fmtPeriodRange(CURRENT_STATE.period);

  if (txCategory) {
    txCategory.innerHTML = "";
    for (const c of CURRENT_CATEGORIES) {
      const opt = document.createElement("option");
      opt.value = String(c.category_id);
      opt.textContent = c.name;
      txCategory.appendChild(opt);
    }
  }

  if (catTableBody) {
    catTableBody.innerHTML = "";
    for (const c of CURRENT_CATEGORIES) {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = c.name;

      const tdBudget = document.createElement("td");
      tdBudget.className = "right";
      tdBudget.textContent = "$" + ((c.budget_cents + c.rollover_cents) / 100).toFixed(2);

      const tdSpent = document.createElement("td");
      tdSpent.className = "right";
      tdSpent.textContent = "$" + (c.spent_cents / 100).toFixed(2);

      const tdRem = document.createElement("td");
      tdRem.className = "right";
      tdRem.textContent = "$" + (c.remaining_cents / 100).toFixed(2);

      tr.appendChild(tdName);
      tr.appendChild(tdBudget);
      tr.appendChild(tdSpent);
      tr.appendChild(tdRem);
      catTableBody.appendChild(tr);
    }
  }
}

/* ================= APP FLOW ================= */
async function loadAppStateAndRender(token) {
  showApp("Loading…");
  hide(dashboardView);
  hide(noCategoriesView);

  const result = await fetchState(token);
  if (result.authFailed) {
    await idbDel(IDB.key);
    return showAuth("Stored token is invalid/expired. Please re-enter.", true);
  }

  const state = result.state || {};

  if (state.initialized === false) {
    show(noCategoriesView);
    setStatus(appStatus, "Budget not yet initialized.");
    initWizardDefaults();
    return;
  }

  hide(noCategoriesView);
  show(dashboardView);

  renderDashboardFromState(state);

  // Remove "Ready" status
  setStatus(appStatus, "");
}

async function refreshAll(token) {
  // Manual refresh button: refreshes state only (Recent Transactions card removed)
  setStatus(txStatus, "Refreshing…");
  try {
    const st = await fetchState(token);
    if (st.authFailed) {
      await idbDel(IDB.key);
      return showAuth("Token invalid/expired. Please re-enter.", true);
    }
    renderDashboardFromState(st.state || {});
    setStatus(txStatus, "Refreshed.", "ok");
  } catch (e) {
    setStatus(txStatus, e.message || String(e), "error");
  }
}

window.addEventListener("unhandledrejection", (ev) => {
  try {
    const msg = ev?.reason?.message || String(ev?.reason || "Unknown error");
    setStatus(globalStatus, `Error: ${msg}`, "error");
    showAuth(`Startup error: ${msg}`, true);
  } catch {}
});

async function bootstrap() {
  setBusy(true);
  setStatus(globalStatus, "Starting…");
  hide(authView);
  hide(appView);

  try {
    const label = getContribLabel();
    if (contribLabel) contribLabel.value = label;
    getOrCreateDeviceId();

    const token = await idbGet(IDB.key);

    if (!token) {
      setBusy(false);
      return showAuth("No token saved. Enter your bearer token to continue.");
    }

    setStatus(globalStatus, "Validating token…");
    const ok = await validateToken(token);
    if (!ok) {
      await idbDel(IDB.key);
      setBusy(false);
      return showAuth("Saved token is invalid or expired. Please enter a new token.", true);
    }

    await loadAppStateAndRender(token);
    setStatus(globalStatus, "");
    setBusy(false);
  } catch (e) {
    setBusy(false);
    showAuth(
      `Startup error: ${e?.message || String(e)}. If you're in Private Browsing or have storage blocked, allow site storage and reload.`,
      true
    );
  }
}

/* ================= EVENTS: AUTH ================= */
saveTokenBtn.addEventListener("click", async () => {
  const token = (tokenInput.value || "").trim();
  if (!token) return setStatus(authStatus, "Please enter a token.", "error");

  setBusy(true);
  setStatus(authStatus, "Validating token…");
  try {
    const ok = await validateToken(token);
    if (!ok) {
      setBusy(false);
      return setStatus(authStatus, "Token is invalid or expired.", "error");
    }
    await idbSet(IDB.key, token);
    setStatus(authStatus, "Token saved. Loading…", "ok");
    await loadAppStateAndRender(token);
    setBusy(false);
  } catch (e) {
    setBusy(false);
    setStatus(authStatus, `Unable to validate token: ${e.message}`, "error");
  }
});

toggleTokenBtn.addEventListener("click", () => {
  const isPw = tokenInput.type === "password";
  tokenInput.type = isPw ? "text" : "password";
  toggleTokenBtn.textContent = isPw ? "Hide" : "Show";
  tokenInput.focus();
});

logoutBtn.addEventListener("click", async () => {
  setBusy(true);
  await idbDel(IDB.key);
  setBusy(false);
  showAuth("Logged out. Enter your bearer token to continue.");
});

retryBtn.addEventListener("click", async () => {
  await bootstrap();
});

/* ================= EVENTS: CONTRIBUTOR LABEL ================= */
contribLabel.addEventListener("blur", () => {
  setContribLabel(contribLabel.value);
});

/* ================= EVENTS: DASHBOARD TRANSACTIONS ================= */
txAmount.addEventListener("blur", () => { txAmount.value = normalizeBudgetDisplay(txAmount.value); });

txClearBtn.addEventListener("click", () => {
  txAmount.value = "";
  txNote.value = "";
  txType.value = "expense";
  setStatus(txStatus, "", "");
});

refreshBtn.addEventListener("click", async () => {
  const token = await idbGet(IDB.key);
  if (!token) return showAuth("Missing token. Please re-enter.", true);
  setBusy(true);
  await refreshAll(token);
  setBusy(false);
});

txSubmitBtn.addEventListener("click", async () => {
  const token = await idbGet(IDB.key);
  if (!token) return showAuth("Missing token. Please re-enter.", true);

  const categoryId = Number(txCategory.value);
  if (!Number.isFinite(categoryId) || categoryId <= 0) return setStatus(txStatus, "Please choose a category.", "error");

  const cents = parseTxAmountToCents();
  if (cents === null) return setStatus(txStatus, "Enter a valid amount greater than $0.00.", "error");

  const type = String(txType.value || "expense");
  const isRefund = type === "refund";

  const note = String(txNote.value || "").trim().slice(0, 240) || undefined;

  const created_by_label = getContribLabel() || undefined;
  const device_id = getOrCreateDeviceId();
  const client_ts = Date.now();
  const client_tx_id = `${device_id}_${client_ts}_${Math.random().toString(16).slice(2)}`;

  const body = {
    created_by_label,
    items: [
      {
        category_id: categoryId,
        amount_cents: cents,
        is_refund: isRefund,
        note,
        device_id,
        client_ts,
        client_tx_id
      }
    ]
  };

  setBusy(true);
  setStatus(txStatus, "Saving…");
  try {
    const res = await postTransaction(token, body);
    if (res.authFailed) {
      await idbDel(IDB.key);
      setBusy(false);
      return showAuth("Token invalid/expired. Please re-enter.", true);
    }

    renderDashboardFromState(res.result || {});
    setStatus(txStatus, "Saved.", "ok");

    txAmount.value = "";
    txNote.value = "";

    setBusy(false);
  } catch (e) {
    setBusy(false);
    setStatus(txStatus, e.message || String(e), "error");
  }
});

/* ================= EVENTS: WIZARD ================= */
wizPeriodType.addEventListener("change", updateStartDateAvailability);

wizNext1.addEventListener("click", () => {
  const err = validateStep1();
  if (err) return setStatus(wizStatus1, err, "error");
  setStatus(wizStatus1, "", "");
  showStep(1);
});

wizBack2.addEventListener("click", () => showStep(0));

wizAddCat.addEventListener("click", () => addWizCategoryRow());

wizNext2.addEventListener("click", () => {
  const err = validateStep2();
  if (err) return setStatus(wizStatus2, err, "error");
  setStatus(wizStatus2, "", "");
  renderReview();
  showStep(2);
});

wizBack3.addEventListener("click", () => showStep(1));

wizSubmit.addEventListener("click", async () => {
  const err1 = validateStep1();
  if (err1) { showStep(0); return setStatus(wizStatus1, err1, "error"); }

  const err2 = validateStep2();
  if (err2) { showStep(1); return setStatus(wizStatus2, err2, "error"); }

  const token = await idbGet(IDB.key);
  if (!token) return showAuth("Missing token. Please re-enter.", true);

  const payload = buildInitPayload();

  setBusy(true);
  setStatus(wizStatus3, "Initializing…");

  try {
    const res = await postInit(token, payload);
    if (res.authFailed) {
      await idbDel(IDB.key);
      setBusy(false);
      return showAuth("Token invalid/expired. Please re-enter.", true);
    }

    setStatus(wizStatus3, "Initialized. Loading…", "ok");

    await loadAppStateAndRender(token);
    setBusy(false);
  } catch (e) {
    setBusy(false);
    setStatus(wizStatus3, e.message, "error");
  }
});

/* ================= START ================= */
bootstrap();
</script>
</body>
</html>
