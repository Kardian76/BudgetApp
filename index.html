<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1320" />
  <title>Purrfect Budget</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 0; background: #0b1320; color: #e9eef7; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 24px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 18px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    p { margin: 10px 0; line-height: 1.35; }
    label { display: block; margin: 12px 0 6px; font-size: 13px; }

    input[type="text"], input[type="password"], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #e9eef7;
    }
    input:disabled { opacity: .7; cursor: not-allowed; }
    input:focus, select:focus { border-color: rgba(130,190,255,.6); outline: none; }

    .row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button {
      border: 0; border-radius: 10px;
      padding: 10px 14px; font-weight: 600;
      background: #2d6cdf; color: #fff; cursor: pointer;
    }
    button.secondary { background: rgba(255,255,255,0.12); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .status { margin-top: 12px; font-size: 13px; opacity: .85; }
    .error { color: #ffb4b4; }
    .ok { color: #b6ffcf; }
    .hidden { display: none; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }

    /* ---------- Step 2 compact rows ---------- */
    .catRow {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .catName { flex: 1 1 auto; min-width: 220px; }
    .catBudget { width: 180px; }

    @media (max-width: 520px) {
      .catRow { flex-wrap: wrap; }
      .catBudget { width: 100%; }
    }
  </style>
</head>

<body>
<div class="wrap">
<div class="card">
<h1>Purrfect Budget</h1>

<!-- ================= AUTH ================= -->
<div id="authView" class="hidden">
  <label>Bearer Token</label>
  <input id="tokenInput" type="password" placeholder="Paste token…" />
  <div class="row">
    <button id="saveTokenBtn">Save Token</button>
    <button id="toggleTokenBtn" class="secondary">Show</button>
  </div>
  <div id="authStatus" class="status"></div>
</div>

<!-- ================= APP ================= -->
<div id="appView" class="hidden">
  <p id="appStatus" class="status"></p>

  <div id="hasCategoriesView" class="hidden">
    <pre class="mono" id="categoriesPreview"></pre>
  </div>

  <div id="noCategoriesView" class="hidden">
    <p class="ok">Welcome. Let’s initialize your budget.</p>

    <!-- ---------- STEP 1 ---------- -->
    <div id="wizStep1" class="card">
      <h1>Step 1 — Budget period</h1>

      <label>Period Type</label>
      <select id="wizPeriodType">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly" selected>Every Two Weeks</option>
        <option value="semi_monthly">Twice a Month</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
      </select>

      <label>Start Date (MM-DD-YYYY)</label>
      <input id="wizStartDate" type="text" placeholder="MM-DD-YYYY" />

      <div class="row">
        <button id="wizNext1">Next</button>
      </div>
      <div id="wizStatus1" class="status"></div>
    </div>

    <!-- ---------- STEP 2 ---------- -->
    <div id="wizStep2" class="card hidden">
      <h1>Step 2 — Categories</h1>
      <div id="wizCatList"></div>

      <div class="row">
        <button id="wizAddCat" class="secondary">Add Category</button>
        <button id="wizBack2" class="secondary">Back</button>
        <button id="wizNext2">Next</button>
      </div>
      <div id="wizStatus2" class="status"></div>
    </div>

    <!-- ---------- STEP 3 ---------- -->
    <div id="wizStep3" class="card hidden">
      <h1>Step 3 — Review</h1>
      <pre id="wizReviewJson" class="mono"></pre>

      <div class="row">
        <button id="wizBack3" class="secondary">Back</button>
        <button id="wizSubmit">Initialize</button>
      </div>
      <div id="wizStatus3" class="status"></div>
    </div>
  </div>

  <div class="row">
    <button id="logoutBtn" class="secondary">Log Out</button>
  </div>
</div>

<div id="globalStatus" class="status"></div>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const API = {
  baseUrl: "https://purrfect-budget-api.kardian.workers.dev",
  validatePath: "/api/auth/validate",
  statePath: "/api/budget/state",
  initPath: "/api/budget/init"
};
const DBKEY = "bearerToken";

/* ================= DOM ================= */
const $ = id => document.getElementById(id);
const authView = $("authView"), appView = $("appView");
const wizStep1 = $("wizStep1"), wizStep2 = $("wizStep2"), wizStep3 = $("wizStep3");
const wizPeriodType = $("wizPeriodType"), wizStartDate = $("wizStartDate");
const wizCatList = $("wizCatList");

/* ================= DATE HELPERS ================= */
const pad = n => String(n).padStart(2,"0");
const todayYMD = () => {
  const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
const ymdToMdy = y => y ? `${y.slice(5,7)}-${y.slice(8,10)}-${y.slice(0,4)}` : "";
const mdyToYmd = m => {
  const r=/^(\d{2})-(\d{2})-(\d{4})$/.exec(m||"");
  return r ? `${r[3]}-${r[1]}-${r[2]}` : null;
};
const usesStartDate = p => ["weekly","biweekly","quarterly"].includes(p);

/* ================= STEP 2 ================= */
function addWizCategoryRow(name="", budget="") {
  const d=document.createElement("div");
  d.className="catRow";
  d.innerHTML=`
    <input class="catName" placeholder="Category" value="${name}">
    <input class="catBudget" placeholder="Budget" value="${budget}">
    <button class="secondary">Remove</button>`;
  d.querySelector("button").onclick=()=>d.remove();
  wizCatList.appendChild(d);
}
function readCategories(){
  return [...wizCatList.children].map((r,i)=>({
    name:r.querySelector(".catName").value.trim(),
    budget_dollars:r.querySelector(".catBudget").value.trim(),
    sort_order:i+1
  })).filter(c=>c.name);
}

/* ================= START DATE LOGIC ================= */
function updateStartDate(){
  const p=wizPeriodType.value;
  if(usesStartDate(p)){
    wizStartDate.disabled=false;
    wizStartDate.value ||= ymdToMdy(todayYMD());
  }else{
    wizStartDate.disabled=true;
    wizStartDate.value="Not required for this period type";
  }
}

/* ================= WIZARD NAV ================= */
function showStep(n){
  [wizStep1,wizStep2,wizStep3].forEach((s,i)=>s.classList.toggle("hidden",i!==n));
}
$("wizNext1").onclick=()=>{
  if(usesStartDate(wizPeriodType.value)&&!mdyToYmd(wizStartDate.value))
    return $("wizStatus1").textContent="Invalid start date";
  showStep(1);
};
$("wizBack2").onclick=()=>showStep(0);
$("wizNext2").onclick=()=>{ $("wizReviewJson").textContent=
  JSON.stringify({
    period_type:wizPeriodType.value,
    period_anchor_date:usesStartDate(wizPeriodType.value)?mdyToYmd(wizStartDate.value):todayYMD(),
    categories:readCategories()
  },null,2);
  showStep(2);
};
$("wizBack3").onclick=()=>showStep(1);
$("wizAddCat").onclick=()=>addWizCategoryRow();

/* ================= INIT ================= */
wizPeriodType.onchange=updateStartDate;
updateStartDate();
addWizCategoryRow("Groceries","300.00");
addWizCategoryRow("Gas","120.00");
</script>
</body>
</html>
