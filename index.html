<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purrfect Budget</title>
  <meta name="theme-color" content="#0b1220" />

  <!-- Optional: if you already have a manifest & icons, keep these -->
  <!-- <link rel="manifest" href="./manifest.webmanifest"> -->

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
    header { padding: 16px; border-bottom: 1px solid rgba(127,127,127,.25); }
    main { padding: 16px; max-width: 960px; margin: 0 auto; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid rgba(127,127,127,.25); border-radius: 12px; padding: 12px; flex: 1 1 320px; }
    label { display: block; font-size: 12px; opacity: .8; margin-top: 10px; }
    input[type="text"], input[type="number"] {
      width: 100%; box-sizing: border-box; padding: 10px; border-radius: 10px;
      border: 1px solid rgba(127,127,127,.35); background: transparent;
    }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35);
      background: transparent; cursor: pointer;
    }
    button.primary { border-width: 2px; }
    pre { white-space: pre-wrap; word-break: break-word; font-size: 12px; opacity: .9; }
    .muted { opacity: .8; font-size: 12px; }
    .ok { color: #2aa876; }
    .err { color: #d44; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 6px 4px; border-bottom: 1px solid rgba(127,127,127,.2); text-align: left; }
    .right { text-align: right; }
  </style>
</head>

<body>
  <header>
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:16px; flex-wrap:wrap;">
      <div>
        <div style="font-size:18px; font-weight:700;">Purrfect Budget</div>
        <div class="muted" id="subtitle">Loading…</div>
      </div>
      <div class="muted" id="status"></div>
    </div>
  </header>

  <main>
    <div class="row">
      <section class="card">
        <div style="font-weight:700; margin-bottom:8px;">Connection</div>

        <label>Worker Base URL</label>
        <input id="baseUrl" type="text" placeholder="https://budgetapp-api.kardian.workers.dev" />

        <label>AUTH Token (Bearer)</label>
        <input id="authToken" type="text" placeholder="Paste token here" />

        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button id="saveConn" class="primary">Save</button>
          <button id="refresh">Refresh State</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Tip: This stores settings in <code>localStorage</code> on the device. Your actual budget state remains shared in D1.
        </div>
      </section>

      <section class="card">
        <div style="font-weight:700; margin-bottom:8px;">Budget State</div>
        <div class="muted" id="periodLine">—</div>

        <div style="margin-top:10px; overflow:auto;">
          <table id="budgetTable">
            <thead>
              <tr>
                <th>Category</th>
                <th class="right">Budget</th>
                <th class="right">Rollover</th>
                <th class="right">Spent</th>
                <th class="right">Remaining</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <details style="margin-top:10px;">
          <summary>Raw JSON</summary>
          <pre id="rawJson">—</pre>
        </details>
      </section>
    </div>

    <div class="row" style="margin-top:16px;">
      <section class="card">
        <div style="font-weight:700; margin-bottom:8px;">Update “Next Period” Settings</div>
        <div class="muted">Writes to <code>POST /api/budget/settings</code>. This should affect the next effective period per your Worker logic.</div>

        <label>Next Groceries (cents)</label>
        <input id="ng" type="number" step="1" min="0" />

        <label>Next Gas (cents)</label>
        <input id="nGas" type="number" step="1" min="0" />

        <label>Next Kids (cents)</label>
        <input id="nKids" type="number" step="1" min="0" />

        <label>Next Date Nights (cents)</label>
        <input id="nDates" type="number" step="1" min="0" />

        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button id="prefill">Prefill From Current Budgets</button>
          <button id="saveSettings" class="primary">Save Settings</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Note: keeping these as integers avoids rounding differences across platforms.
        </div>
      </section>

      <section class="card">
        <div style="font-weight:700; margin-bottom:8px;">Rollover Sanity Check</div>
        <div class="muted">
          This page will compute whether your API is internally consistent:
          <code>remaining = budgets + rollover - spent</code>.
          If you see “Mismatch”, your Worker is likely double-counting or mis-populating rollover.
        </div>

        <div style="margin-top:10px;" id="rolloverCheck">—</div>
      </section>
    </div>
  </main>

  <script>
    // Defaults for your environment
    const DEFAULT_BASE = "https://budgetapp-api.kardian.workers.dev";

    function $(id) { return document.getElementById(id); }

    function setStatus(msg, kind) {
      const el = $("status");
      el.textContent = msg || "";
      el.className = kind === "err" ? "err" : (kind === "ok" ? "ok" : "");
    }

    function dollars(cents) {
      // Display helper only; keep cents as integers in API/storage.
      const sign = cents < 0 ? "-" : "";
      const abs = Math.abs(cents);
      return sign + "$" + (abs / 100).toFixed(2);
    }

    function getConn() {
      const baseUrl = ($("baseUrl").value || "").trim() || DEFAULT_BASE;
      const token = ($("authToken").value || "").trim();
      return { baseUrl, token };
    }

    function saveConn() {
      const { baseUrl, token } = getConn();
      localStorage.setItem("pb_baseUrl", baseUrl);
      localStorage.setItem("pb_authToken", token);
      setStatus("Saved connection settings.", "ok");
    }

    function loadConn() {
      const baseUrl = localStorage.getItem("pb_baseUrl") || DEFAULT_BASE;
      const token = localStorage.getItem("pb_authToken") || "";
      $("baseUrl").value = baseUrl;
      $("authToken").value = token;
    }

    async function apiFetch(path, options = {}) {
      const { baseUrl, token } = getConn();
      if (!token) throw new Error("Missing AUTH token.");
      const url = baseUrl.replace(/\/$/, "") + path;

      const headers = Object.assign(
        { "Authorization": "Bearer " + token },
        options.headers || {}
      );

      const resp = await fetch(url, Object.assign({}, options, { headers }));
      const text = await resp.text();

      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }

      if (!resp.ok) {
        const msg = (json && (json.error || json.message)) ? (json.error || json.message) : ("HTTP " + resp.status);
        throw new Error(msg + " (" + url + ")");
      }
      return json;
    }

    function renderState(state) {
      // Header text
      $("subtitle").textContent = state?.period_label ? state.period_label : "—";
      $("periodLine").textContent = [
        state?.period_key ? ("period_key=" + state.period_key) : null,
        state?.period_ends_text ? ("ends " + state.period_ends_text) : null,
        state?.now ? ("server now " + state.now) : null
      ].filter(Boolean).join(" · ");

      // Raw JSON
      $("rawJson").textContent = JSON.stringify(state, null, 2);

      // Table
      const tbody = $("budgetTable").querySelector("tbody");
      tbody.innerHTML = "";

      const cats = ["groceries", "gas", "kids", "date_nights"];
      for (const c of cats) {
        const b = state?.budgets_cents?.[c] ?? 0;
        const r = state?.rollover_cents?.[c] ?? 0;
        const s = state?.spent_cents?.[c] ?? 0;
        const rem = state?.remaining_cents?.[c] ?? 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.replace("_", " ")}</td>
          <td class="right">${dollars(b)}</td>
          <td class="right">${dollars(r)}</td>
          <td class="right">${dollars(s)}</td>
          <td class="right">${dollars(rem)}</td>
        `;
        tbody.appendChild(tr);
      }

      // Rollover sanity check: remaining should equal budgets + rollover - spent
      const mismatches = [];
      for (const c of cats) {
        const b = state?.budgets_cents?.[c] ?? 0;
        const r = state?.rollover_cents?.[c] ?? 0;
        const s = state?.spent_cents?.[c] ?? 0;
        const rem = state?.remaining_cents?.[c] ?? 0;
        const expected = b + r - s;
        if (expected !== rem) {
          mismatches.push({ category: c, expected, got: rem });
        }
      }

      const chk = $("rolloverCheck");
      if (!mismatches.length) {
        chk.innerHTML = `<div class="ok">OK: remaining = budgets + rollover - spent for all categories.</div>`;
      } else {
        const lines = mismatches.map(m =>
          `<li><code>${m.category}</code>: expected ${dollars(m.expected)} but got ${dollars(m.got)}</li>`
        ).join("");
        chk.innerHTML = `
          <div class="err">Mismatch detected:</div>
          <ul>${lines}</ul>
          <div class="muted">This typically indicates rollover is being populated incorrectly or the remaining calculation differs between server and UI expectations.</div>
        `;
      }
    }

    async function refreshState() {
      setStatus("Loading state…");
      const state = await apiFetch("/api/budget/state", { method: "GET" });
      renderState(state);
      setStatus("State loaded.", "ok");
      return state;
    }

    function prefillFromCurrent(state) {
      // Prefill “next” inputs from current budgets (not rollover)
      $("ng").value = state?.budgets_cents?.groceries ?? 0;
      $("nGas").value = state?.budgets_cents?.gas ?? 0;
      $("nKids").value = state?.budgets_cents?.kids ?? 0;
      $("nDates").value = state?.budgets_cents?.date_nights ?? 0;
      setStatus("Prefilled next settings from current budgets.", "ok");
    }

    async function saveSettings() {
      setStatus("Saving settings…");
      const payload = {
        next_groceries_cents: Number($("ng").value || 0),
        next_gas_cents: Number($("nGas").value || 0),
        next_kids_cents: Number($("nKids").value || 0),
        next_date_nights_cents: Number($("nDates").value || 0),
      };

      const resp = await apiFetch("/api/budget/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      setStatus("Settings saved. Refreshing state…", "ok");
      await refreshState();
      return resp;
    }

    // Wire up UI
    (function init() {
      loadConn();

      $("saveConn").addEventListener("click", () => {
        try { saveConn(); } catch (e) { setStatus(e.message, "err"); }
      });

      $("refresh").addEventListener("click", async () => {
        try { await refreshState(); } catch (e) { setStatus(e.message, "err"); }
      });

      $("prefill").addEventListener("click", async () => {
        try {
          const state = await refreshState();
          prefillFromCurrent(state);
        } catch (e) {
          setStatus(e.message, "err");
        }
      });

      $("saveSettings").addEventListener("click", async () => {
        try { await saveSettings(); } catch (e) { setStatus(e.message, "err"); }
      });

      // Auto-load state if token exists
      if (($("authToken").value || "").trim()) {
        refreshState().catch(e => setStatus(e.message, "err"));
      } else {
        setStatus("Paste token and click Refresh State.");
      }
    })();
  </script>
</body>
</html>
